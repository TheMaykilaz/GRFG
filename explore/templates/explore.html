{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'explore/css/explore.css' %}">

<div class="main-container">
  <section class="content">
    <h1>{{ title|capfirst }}</h1>

    <nav class="menu">
      {% for item in menu %}
        <a href="{% url item.url_name %}">{{ item.name }}</a>
        {% if not forloop.last %} | {% endif %}
      {% endfor %}
    </nav>

    <!-- üîç –§–æ—Ä–º–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó -->
    <form id="filters-form" class="filters-form">
      <div class="filters">
        <input type="text" id="search-input" name="search" placeholder="Search by name or symbol..." />
        <input type="number" step="0.01" id="price-min" name="price_min" placeholder="Min Price" />
        <input type="number" step="0.01" id="price-max" name="price_max" placeholder="Max Price" />

        <select id="sort-select" name="ordering">
          <option value="">Sort By</option>
          <option value="price">Price ‚Üë</option>
          <option value="-price">Price ‚Üì</option>
          <option value="market_cap">Market Cap ‚Üë</option>
          <option value="-market_cap">Market Cap ‚Üì</option>
        </select>

        <button type="submit">Filter</button>
      </div>
    </form>

    <h2>All crypto:</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Symbol</th>
            <th>Price (USD)</th>
            <th>1h %</th>
            <th>24h %</th>
            <th>7d %</th>
            <th>Market Cap</th>
            <th>Volume (24h)</th>
          </tr>
        </thead>
        <tbody id="crypto-data">
          <!-- JS –≤—Å—Ç–∞–≤–∏—Ç—å —Å—é–¥–∏ —Ä—è–¥–∫–∏ -->
        </tbody>
      </table>
    </div>

    <!-- üìÑ –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
    <div id="pagination" class="pagination"></div>
  </section>

  <aside class="sidebar">
    <div class="sidebar-inner">
      <h2>Today's Cap</h2>

      <div class="sidebar-section">
        <h3>Dominance</h3>
        <div class="table-container">
          {{ alldom|safe }}
        </div>
      </div>

      <div class="sidebar-section">
        <h3>Total Cap</h3>
        <p>{{ total_cap }}</p>
      </div>

      <div class="sidebar-section">
        <h3>Fear and Greed</h3>
        <p>
          {% for item in fg %}
            <span>{{ item }}</span>{% if not forloop.last %} | {% endif %}
          {% endfor %}
        </p>
      </div>
    </div>
  </aside>
</div>

<!-- JS -->
<script>
  async function fetchCryptos(page = 1) {
    const form = document.getElementById("filters-form");
    const formData = new FormData(form);
    formData.append("page", page);

    const params = new URLSearchParams(formData);
    const url = "{% url 'explore:crypto-list-api' %}?" + params.toString();

    try {
      const response = await fetch(url);
      const data = await response.json();

      const tbody = document.getElementById("crypto-data");
      tbody.innerHTML = "";

      // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Set –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤
      const uniqueSymbols = new Set();

      data.results.forEach(token => {
        // –ü—Ä–∏–≤–æ–¥–∏–º–æ —Å–∏–º–≤–æ–ª –¥–æ –≤–µ—Ä—Ö–Ω—å–æ–≥–æ —Ä–µ–≥—ñ—Å—Ç—Ä—É –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è
        const symbolUpper = token.symbol.toUpperCase();
        
        // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –¥—É–±–ª—ñ–∫–∞—Ç–∏
        if (uniqueSymbols.has(symbolUpper)) {
          console.warn(`Duplicate skipped: ${token.symbol}`);
          return;
        }
        uniqueSymbols.add(symbolUpper);

        const row = `
          <tr onclick="window.location.href='{% url 'explore:crypto-detail' 'REPLACE' %}'.replace('REPLACE', '${token.symbol.toLowerCase()}')" 
              style="cursor: pointer;">
            <td>${token.name}</td>
            <td>${symbolUpper}</td> <!-- –í–∏–≤–æ–¥–∏–º–æ —É –≤–µ—Ä—Ö–Ω—å–æ–º—É —Ä–µ–≥—ñ—Å—Ç—Ä—ñ -->
            <td>$${parseFloat(token.price).toFixed(2)}</td>
            <td>${token.percent_1h}%</td>
            <td>${token.percent_24h}%</td>
            <td>${token.percent_7d}%</td>
            <td>$${Number(token.market_cap).toLocaleString()}</td>
            <td>$${Number(token.volume_24h).toLocaleString()}</td>
          </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", row);
      });

      // –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω)
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      const currentPage = page;
      if (data.previous) {
        pagination.innerHTML += `<button onclick="fetchCryptos(${currentPage - 1})">Previous</button>`;
      }
      if (data.next) {
        pagination.innerHTML += `<button onclick="fetchCryptos(${currentPage + 1})">Next</button>`;
      }

    } catch (err) {
      console.error("Fetch error:", err);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    fetchCryptos();

    document.getElementById("filters-form").addEventListener("submit", e => {
      e.preventDefault();
      fetchCryptos(1);
    });
  });
</script>
{% endblock %}
